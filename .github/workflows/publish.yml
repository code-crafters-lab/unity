on:
  push:
    tags:
      - '*-v*'  # åŒ¹é… <æ¨¡å—å>-v<ç‰ˆæœ¬å·> æ ¼å¼çš„ Tag
  workflow_dispatch:
    inputs:
      module_name:
        description: 'æ¨¡å—åç§°'
        required: true
      version:
        description: 'ç‰ˆæœ¬å· (æ ¼å¼: x.y.z)'
        required: true
        default: '0.0.0'
      is_test:
        description: 'æ˜¯å¦ä¸ºæµ‹è¯•æ¨¡å¼ (ä¸å®é™…å‘å¸ƒ)'
        required: false
        type: boolean
        default: true

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: æ‰“å°è§¦å‘ä¿¡æ¯
        run: |
          echo "è§¦å‘ç±»å‹: ${{ github.event_name }}"
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "æ‰‹åŠ¨è§¦å‘å‚æ•°:"
            echo "  æ¨¡å—åç§°: ${{ github.event.inputs.module_name }}"
            echo "  ç‰ˆæœ¬å·: ${{ github.event.inputs.version }}"
            echo "  æµ‹è¯•æ¨¡å¼: ${{ github.event.inputs.is_test }}"
          else
            echo "è‡ªåŠ¨è§¦å‘ Tag: ${{ github.ref_name }}"
          fi

      - name: Checkoutä»£ç ï¼ˆå«å®Œæ•´å†å²ï¼‰
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # è§£æå½“å‰ Tag çš„æ¨¡å—åå’Œç‰ˆæœ¬å·
      - name: è§£æTagè·å–æ¨¡å—å’Œç‰ˆæœ¬
        id: parse_tag
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            # æ‰‹åŠ¨è§¦å‘æ—¶ä½¿ç”¨è¾“å…¥å‚æ•°
            MODULE_NAME="${{ github.event.inputs.module_name }}"
            VERSION="${{ github.event.inputs.version }}"
            CURRENT_TAG="${MODULE_NAME}-v${VERSION}"
          
            # éªŒè¯ç‰ˆæœ¬å·æ ¼å¼
            if ! [[ $VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
              echo "âŒ ç‰ˆæœ¬å· $VERSION ä¸ç¬¦åˆè¯­ä¹‰åŒ–ç‰ˆæœ¬è§„èŒƒ (MAJOR.MINOR.PATCH)"
              exit 1
            fi
          else
            # è‡ªåŠ¨è§¦å‘æ—¶è§£æTag
            TAG_NAME="${{ github.ref_name }}"
            if [[ $TAG_NAME =~ ^([a-zA-Z0-9_-]+)-v([0-9]+\.[0-9]+\.[0-9]+)$ ]]; then
              MODULE_NAME="${BASH_REMATCH[1]}"
              VERSION="${BASH_REMATCH[2]}"
              CURRENT_TAG="${TAG_NAME}"
            else
              echo "âŒ Tag æ ¼å¼é”™è¯¯ï¼éœ€ç¬¦åˆï¼š<æ¨¡å—å>-v<ç‰ˆæœ¬å·>ï¼ˆå¦‚moduleA-v1.0.0ï¼‰"
              exit 1
            fi
          fi
          
          echo "module_name=$MODULE_NAME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "current_tag=$CURRENT_TAG" >> $GITHUB_OUTPUT


      # éªŒè¯æ¨¡å—å­˜åœ¨
      - name: éªŒè¯æ¨¡å—ç›®å½•
        run: |
          MODULE_NAME="${{ steps.parse_tag.outputs.module_name }}"
          if [ ! -d "$MODULE_NAME" ]; then
            echo "âŒ æ¨¡å— $MODULE_NAME ä¸å­˜åœ¨"
            exit 1
          fi

      # æ£€æŸ¥ CURRENT_TAG æ˜¯å¦å­˜åœ¨
      - name: æ£€æŸ¥ CURRENT_TAG æ˜¯å¦å­˜åœ¨
        id: check_current_tag
        run: |
          CURRENT_TAG="${{ steps.parse_tag.outputs.current_tag }}"
          if git rev-parse "$CURRENT_TAG" >/dev/null 2>&1; then
            echo "âœ… Tag $CURRENT_TAG å­˜åœ¨"
            echo "tag_exists=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ Tag $CURRENT_TAG ä¸å­˜åœ¨ï¼Œå°†ä½¿ç”¨ HEAD ä½œä¸ºå½“å‰ç‰ˆæœ¬å‚è€ƒç‚¹"
            echo "tag_exists=false" >> $GITHUB_OUTPUT
          fi

      # æŸ¥æ‰¾å½“å‰æ¨¡å—çš„ä¸Šä¸€ä¸ªå‘å¸ƒ Tag
      - name: æŸ¥æ‰¾ä¸Šä¸€ä¸ªå‘å¸ƒ Tag
        id: find_previous_tag
        run: |
          MODULE_NAME="${{ steps.parse_tag.outputs.module_name }}"
          CURRENT_TAG="${{ steps.parse_tag.outputs.current_tag }}"
          ALL_MODULE_TAGS=$(git tag --list "${MODULE_NAME}-v*" | sort -V)
          echo "è¯¥æ¨¡å—çš„æ‰€æœ‰å‘å¸ƒ Tagï¼š$ALL_MODULE_TAGS"
          
          PREVIOUS_TAG=$(echo "$ALL_MODULE_TAGS" | grep -v "^$CURRENT_TAG$" | tail -1)
          
          if [ -z "$PREVIOUS_TAG" ]; then
            echo "âš ï¸ æœªæ‰¾åˆ°ä¸Šä¸€ä¸ªå‘å¸ƒTagï¼Œæ—¥å¿—å°†åŒ…å«ä»åˆå§‹æäº¤åˆ°å½“å‰çš„å˜æ›´"
            echo "previous_tag=" >> $GITHUB_OUTPUT
          else
            echo "âœ… ä¸Šä¸€ä¸ªå‘å¸ƒTagï¼š$PREVIOUS_TAG"
            echo "previous_tag=$PREVIOUS_TAG" >> $GITHUB_OUTPUT
          fi

      # ç”Ÿæˆæ›´æ–°æ—¥å¿—ï¼ˆåˆ†ç±»ï¼‰
      - name: ç”Ÿæˆæ›´æ–°æ—¥å¿—
        id: generate_changelog
        run: |
          MODULE_NAME="${{ steps.parse_tag.outputs.module_name }}"
          CURRENT_TAG="${{ steps.parse_tag.outputs.current_tag }}"
          PREVIOUS_TAG="${{ steps.find_previous_tag.outputs.previous_tag }}"
          VERSION="${{ steps.parse_tag.outputs.version }}"
          TAG_EXISTS="${{ steps.check_current_tag.outputs.tag_exists }}"
          
          CHANGELOG_FILE="${MODULE_NAME}_v${VERSION}_changelog.md"
  
          echo "# unity-${MODULE_NAME} v${VERSION} æ›´æ–°æ—¥å¿—" > ${CHANGELOG_FILE}
          echo "å‘å¸ƒæ—¶é—´ï¼š$(date +'%Y-%m-%d')" >> $CHANGELOG_FILE
          echo "" >> ${CHANGELOG_FILE}
          
          # åŠ¨æ€è°ƒæ•´æ—¥å¿—è·å–èŒƒå›´
          if [ "${TAG_EXISTS}" = "true" ]; then
          LOG_RANGE="${PREVIOUS_TAG:+$PREVIOUS_TAG..}${CURRENT_TAG}"
          else
          LOG_RANGE="${PREVIOUS_TAG:+$PREVIOUS_TAG..}HEAD"
          fi
          echo "æ—¥å¿—è·å–èŒƒå›´ï¼š${LOG_RANGE}"
          
          # æå–æäº¤è®°å½•ï¼ˆæŒ‰ç±»å‹åˆ†ç±»ï¼‰
          FEATURES=$(git log "${LOG_RANGE}" --pretty=format:"- [%h] %s" --abbrev-commit -- "${MODULE_NAME}/" | grep -i '^- \[[a-z0-9]*\] feat[:(]')
          BUGFIXES=$(git log "${LOG_RANGE}" --pretty=format:"- [%h] %s" --abbrev-commit -- "${MODULE_NAME}/" | grep -i '^- \[[a-z0-9]*\] fix[:(]')
          DOCS=$(git log "${LOG_RANGE}" --pretty=format:"- [%h] %s" --abbrev-commit -- "${MODULE_NAME}/" | grep -i '^- \[[a-z0-9]*\] docs[:(]')
          OTHERS=$(git log "${LOG_RANGE}" --pretty=format:"- [%h] %s" --abbrev-commit -- "${MODULE_NAME}/" | grep -iv '^- \[[a-z0-9]*\] \(feat\|fix\|docs\)[:(]')
          
          
          echo "## å˜æ›´å†…å®¹" >> "${CHANGELOG_FILE}"
          echo "" >> ${CHANGELOG_FILE}
          
          echo "## æ–°åŠŸèƒ½" >> "${CHANGELOG_FILE}"
          [ -n "${FEATURES}" ] && echo "${FEATURES}" >> "${CHANGELOG_FILE}" || echo "- æ— " >> "${CHANGELOG_FILE}"
        
          echo -e "\n## ä¿®å¤" >> "${CHANGELOG_FILE}"
          [ -n "${BUGFIXES}" ] && echo "${BUGFIXES}" >> "${CHANGELOG_FILE}" || echo "- æ— " >> "${CHANGELOG_FILE}"
          
          echo -e "\n## æ–‡æ¡£" >> "${CHANGELOG_FILE}"
          [ -n "${DOCS}" ] && echo "${DOCS}" >> "${CHANGELOG_FILE}" || echo "- æ— " >> "${CHANGELOG_FILE}"
          
          echo -e "\n## å…¶ä»–" >> "${CHANGELOG_FILE}"
          [ -n "${OTHERS}" ] && echo "${OTHERS}" >> "${CHANGELOG_FILE}" || echo "- æ— " >> "${CHANGELOG_FILE}"
          
          if [ ! -s "${CHANGELOG_FILE}" ] || ! grep -q "\- \[" "${CHANGELOG_FILE}"; then
            echo "- é¦–æ¬¡å‘å¸ƒæ¨¡å— ${MODULE_NAME} v${VERSION}" >> "${CHANGELOG_FILE}"
          fi
          
          echo -e "âœ… æ›´æ–°æ—¥å¿—ç”Ÿæˆå®Œæˆï¼š\n"
          cat "${CHANGELOG_FILE}"

          echo "changelog<<EOF" >> "${GITHUB_OUTPUT}"
          cat $CHANGELOG_FILE >> "${GITHUB_OUTPUT}"
          echo "EOF" >> "${GITHUB_OUTPUT}"

      # æ›´æ–°æ¨¡å—ç‰ˆæœ¬å·
      - name: æ›´æ–°gradle.propertiesç‰ˆæœ¬å·
        run: |
          MODULE_NAME="${{ steps.parse_tag.outputs.module_name }}"
          VERSION="${{ steps.parse_tag.outputs.version }}"
          sed -i "s/^version=.*/version=$VERSION/" "$MODULE_NAME/gradle.properties"
          
          # ä»…åœ¨éæµ‹è¯•æ¨¡å¼ä¸‹æäº¤å˜æ›´
          if [[ "${{ github.event_name }}" != "workflow_dispatch" || !"${{ github.event.inputs.is_test }}" = "true" ]]; then
            git config user.name "GitHub Actions"
            git config user.email "actions@github.com"
            git add "$MODULE_NAME/gradle.properties"
            git commit -m "chore: æ›´æ–° $MODULE_NAME ç‰ˆæœ¬åˆ° $VERSION"
            git push origin HEAD
          else
            echo "æµ‹è¯•æ¨¡å¼ï¼šä¸æäº¤ç‰ˆæœ¬å˜æ›´"
          fi

      # é…ç½® JDK å¹¶å‘å¸ƒæ¨¡å—
      - name: é…ç½®JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: å‘å¸ƒæ¨¡å—åˆ°ä»“åº“
        if: github.event_name != 'workflow_dispatch' || !github.event.inputs.is_test
        run: |
          MODULE_NAME="${{ steps.parse_tag.outputs.module_name }}"
          ./gradlew :$MODULE_NAME:publish --info
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # åˆ›å»º GitHub Release å¹¶é™„åŠ æ›´æ–°æ—¥å¿—
      - name: åˆ›å»º GitHub Releaseï¼ˆå«æ›´æ–°æ—¥å¿—ï¼‰
        if: github.event_name != 'workflow_dispatch' || !github.event.inputs.is_test
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ steps.parse_tag.outputs.module_name }} v${{ steps.parse_tag.outputs.version }}
          body: ${{ steps.generate_changelog.outputs.changelog }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # å‘å¸ƒæˆåŠŸé€šçŸ¥
      - name: å‘å¸ƒæˆåŠŸé€šçŸ¥
        if: success() && (github.event_name != 'workflow_dispatch' || !github.event.inputs.is_test)
        run: |
          curl -X POST -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -d '{"body": "ğŸ‰ æ¨¡å— ${{ steps.parse_tag.outputs.module_name }} v${{ steps.parse_tag.outputs.version }} å‘å¸ƒæˆåŠŸï¼æŸ¥çœ‹æ›´æ–°æ—¥å¿—ï¼š${{ github.event.repository.html_url }}/releases/tag/${{ github.ref_name }}"}' \
            "${{ github.event.repository.html_url }}/issues/${{ github.event.number }}/comments"

  rollback:
    runs-on: ubuntu-latest
    needs: publish
    if: failure() && (github.event_name != 'workflow_dispatch' || !github.event.inputs.is_test)
    steps:
      - name: å›æ»š Tag
        run: |
          TAG_NAME="${{ github.ref_name }}"
          git tag -d $TAG_NAME
          git push origin :refs/tags/$TAG_NAME
